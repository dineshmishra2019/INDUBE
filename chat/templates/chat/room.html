{% extends 'base.html' %}
{% load static %}

{% block title %}Chat Room{% endblock %}

{% block content %}
<div class="chat-page-container">
    <div class="chat-main-panel">
        <h2>Public Chat Room</h2>
        <p>You can talk to the AI assistant by starting your message with <code>@bot</code>.</p>
        <div id="chat-log" class="chat-log">
            <!-- Chat messages will appear here -->
        </div>
        <form id="chat-form" style="display: flex; gap: 1em;">
            <input id="chat-message-input" type="text" autocomplete="off" style="flex-grow: 1;" placeholder="Type a message...">
            <button id="chat-message-submit" type="submit" class="btn">Send</button>
        </form>
    </div>
    <div class="chat-sidebar">
        <h3>Online Users (<span id="user-count">0</span>)</h3>
        <ul id="user-list">
            <!-- Online users will be listed here -->
        </ul>
    </div>
</div>

<script>
    const currentUsername = "{{ request.user.username }}";
    const chatLog = document.querySelector('#chat-log');
    const chatMessageInput = document.querySelector('#chat-message-input');
    const chatForm = document.querySelector('#chat-form');
    const userList = document.querySelector('#user-list');
    const userCount = document.querySelector('#user-count');

    function appendMessage(username, message, type) {
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('chat-message', type);

        const metaElement = document.createElement('div');
        metaElement.classList.add('meta');
        metaElement.textContent = username;

        const textElement = document.createElement('div');
        textElement.classList.add('text');
        textElement.textContent = message;

        messageContainer.appendChild(metaElement);
        messageContainer.appendChild(textElement);
        chatLog.appendChild(messageContainer);
    }

    // Establish WebSocket connection
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/'
    );

    chatSocket.onopen = function(e) {
        console.log('Chat socket successfully connected.');
        chatMessageInput.focus();
    };

    // Handle incoming messages safely
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (data.type === 'user_list') {
            // Update the online user list
            userList.innerHTML = ''; // Clear the list
            data.users.forEach(user => {
                const userElement = document.createElement('li');
                userElement.textContent = user;
                userList.appendChild(userElement);
            });
            userCount.textContent = data.users.length;
        } else if (data.type === 'chat_message') {
            // Handle a new chat message
            const messageType = data.username === currentUsername ? 'user' : 'other';
            appendMessage(data.username, data.message, messageType);
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
        chatLog.innerHTML += '<div style="color: red;">Connection lost. Please refresh the page.</div>';
    };

    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = chatMessageInput.value;
        if (message.trim() === '') {
            return;
        }
        
        // Send message to server
        chatSocket.send(JSON.stringify({ 'message': message }));
        
        // Clear input
        chatMessageInput.value = '';
    });
</script>
{% endblock %}