{% extends 'base.html' %}
{% load static %}

{% block title %}Chat with {{ other_user.username }}{% endblock %}

{% block content %}
<div class="chat-container">
    <h2>Chat with {{ other_user.username }}</h2>
    <p>You can talk to the AI assistant by starting your message with <code>@bot</code>. The conversation will be private to you.</p>
    <div id="chat-log" class="chat-log">
        {% for message in messages %}
            <div class="chat-message {% if message.sender == request.user %}user{% else %}other{% endif %}">
                <div class="meta">{{ message.sender.username }}</div>
                <div class="text">{{ message.text }}</div>
            </div>
        {% empty %}
            <div id="no-messages-placeholder" class="chat-loading" style="text-align: center; padding-top: 2em;">No messages yet. Start the conversation!</div>
        {% endfor %}
    </div>
    <form id="chat-form" style="display: flex; gap: 1em;">
        <input id="chat-message-input" type="text" autocomplete="off" style="flex-grow: 1;" placeholder="Type a message...">
        <button id="chat-message-submit" type="submit" class="btn">Send</button>
    </form>
</div>

<script>
    const otherUserId = {{ other_user.id }};
    const currentUsername = "{{ request.user.username }}";
    const chatLog = document.querySelector('#chat-log');
    const chatMessageInput = document.querySelector('#chat-message-input');
    const chatForm = document.querySelector('#chat-form');

    // Scroll to bottom on page load
    chatLog.scrollTop = chatLog.scrollHeight;

    // Establish WebSocket connection
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/private/' + otherUserId + '/'
    );

    chatSocket.onopen = function(e) {
        console.log('Private chat socket successfully connected.');
        chatMessageInput.focus();
    };

    function appendMessage(username, message, type) {
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('chat-message', type);

        const metaElement = document.createElement('div');
        metaElement.classList.add('meta');
        metaElement.textContent = username;

        const textElement = document.createElement('div');
        textElement.classList.add('text');
        textElement.textContent = message;

        messageContainer.appendChild(metaElement);
        messageContainer.appendChild(textElement);
        chatLog.appendChild(messageContainer);
    }

    // Handle incoming messages safely
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (data.type === 'chat_message') {
            // Remove placeholder if it exists
            const placeholder = document.querySelector('#no-messages-placeholder');
            if (placeholder) {
                placeholder.remove();
            }

            const messageType = data.username === currentUsername ? 'user' : 'other';
            appendMessage(data.username, data.message, messageType);
            // Scroll to the bottom after adding the message
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
        chatLog.innerHTML += '<div style="color: red;">Connection lost. Please refresh the page.</div>';
    };

    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = chatMessageInput.value;
        if (message.trim() === '') { return; }
        chatSocket.send(JSON.stringify({ 'message': message }));
        chatMessageInput.value = '';
    });
</script>
{% endblock %}