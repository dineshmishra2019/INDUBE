{% extends 'base.html' %}

{% block title %}AI Chat{% endblock %}

{% block content %}
<div class="chat-container">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1em; margin-bottom: 1em;">
        <div>
            <h2>AI Chat</h2>
            <p style="margin: 0;">Have a private conversation with the AI assistant. Your chat history is remembered.</p>
        </div>
        <button id="clear-history-btn" class="btn" style="background-color: #dc3545;">Clear History</button>
    </div>
    <div id="chat-log" class="chat-log">
        <!-- Chat messages will appear here -->
    </div>
    <form id="chat-form" style="display: flex; gap: 1em;">
        <select id="model-select" title="Choose an AI model">
            {% for model in available_models %}
                <option value="{{ model }}" {% if model == default_model %}selected{% endif %}>{{ model }}</option>
            {% endfor %}
        </select>
        <input id="chat-message-input" type="text" autocomplete="off" style="flex-grow: 1;" placeholder="Ask the AI something...">
        <button id="chat-message-submit" type="submit" class="btn">Send</button>
    </form>
</div>

<script>
    const chatLog = document.querySelector('#chat-log');
    const chatMessageInput = document.querySelector('#chat-message-input');
    const chatForm = document.querySelector('#chat-form');
    const modelSelect = document.querySelector('#model-select');
    const clearHistoryBtn = document.querySelector('#clear-history-btn');

    function appendMessage(username, message, type) {
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('chat-message', type);

        const metaElement = document.createElement('div');
        metaElement.classList.add('meta');
        metaElement.textContent = username;

        const textElement = document.createElement('div');
        textElement.classList.add('text');
        textElement.innerHTML = message.replace(/\n/g, '<br>');

        messageContainer.appendChild(metaElement);
        messageContainer.appendChild(textElement);
        chatLog.appendChild(messageContainer);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    async function sendMessage(event) {
        event.preventDefault();
        const message = chatMessageInput.value.trim();
        const model = modelSelect.value;
        if (message === '') return;

        appendMessage('{{ request.user.username }}', message, 'user');
        chatMessageInput.value = '';
        
        const loadingIndicator = document.createElement('div');
        loadingIndicator.classList.add('chat-loading');
        loadingIndicator.textContent = 'Thinking...';
        chatLog.appendChild(loadingIndicator);
        chatLog.scrollTop = chatLog.scrollHeight;

        try {
            const response = await fetch("{% url 'ai_chat_api' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ message: message, model: model })
            });

            chatLog.removeChild(loadingIndicator);

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: `HTTP error! status: ${response.status}` }));
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            if (data.reply) {
                appendMessage(`AI Assistant (${data.model})`, data.reply, 'other');
            } else if (data.error) {
                appendMessage('Error', data.error, 'other');
            }
        } catch (error) {
            if (chatLog.contains(loadingIndicator)) {
                chatLog.removeChild(loadingIndicator);
            }
            appendMessage('Error', `An error occurred: ${error.message}`, 'other');
        }
    }

    async function clearHistory() {
        const model = modelSelect.value;
        try {
            const response = await fetch("{% url 'ai_chat_api' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ action: 'clear', model: model })
            });
            if (response.ok) {
                chatLog.innerHTML = '<div class="chat-loading" style="text-align: center; padding-top: 2em;">Chat history cleared.</div>';
            } else {
                const errorData = await response.json();
                appendMessage('Error', errorData.error || 'Failed to clear history.', 'other');
            }
        } catch (error) {
            appendMessage('Error', `An error occurred: ${error.message}`, 'other');
        }
    }

    chatForm.addEventListener('submit', sendMessage);
    clearHistoryBtn.addEventListener('click', clearHistory);
    chatMessageInput.focus();
</script>
{% endblock %}